{"version":3,"sources":["sif-update.es6"],"names":[],"mappings":"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","file":"sif-update.js","sourcesContent":["#!/usr/bin/env node\n\n'use strict';\n\n/*    _,                            ,--.   ,---.\n *   /(_                     ,---.  `--'  /  .-'\n *  |   '-._        . ' .   (  .-'  ,--.  |  `-,\n *  \\    ,-.)      -= * =- .-'  `)  |  |  |  .-'\n *   \\((` .(        '/. '  `----'   `--'  `--'\n *    )\\  _/        /         just like magic\n * .-'   '--.      /\n * \\,         \\   /|\n *  ';,_) _)'\\ \\,//    This program is distributed\n *   `\\   (   '._/   under the terms of the MIT license.\n *    |  . '.\n *    |      \\   Please see the `LICENSE.md` file for details.\n *    |  \\|   |\n *     \\  |  /    Send your comments and suggestions to…\n *      '.| /      <https://github.com/v0lkan/sif/issues>.\n */\n\nimport program from 'commander';\nimport byline from 'byline';\nimport request from 'request';\nimport {join} from 'path';\nimport {spawn} from 'child_process';\nimport {createReadStream as read, createWriteStream as write} from 'fs';\n\nimport {printHeader as header, print, printBlank as blank, printError as error} from '../lib/terminal/out';\n\nconst COMMAND = 'update';\nconst SUCCESS = 200;\nconst INDEX_FILE = join(__dirname, '../data/index.idx');\nconst TMP_EXISTING_FILE = join(__dirname, '__tmp_processed');\nconst TMP_PROCESSED_FILE = join(__dirname, '__tmp_existing');\n\nprogram.parse(process.argv);\n\n// TODO: this file needs some cleanup.\n\nprint(COMMAND, 'Started updating the index… This may take a while. Please be patient…');\n\nlet copyAssets = () => {\n    let cat = spawn('cat', [TMP_EXISTING_FILE, TMP_PROCESSED_FILE]);\n    let sort = spawn('sort', ['-u']);\n\n    let indexWriteStream = write(INDEX_FILE, {encoding: 'utf8'});\n\n    sort.stdout.pipe(indexWriteStream);\n\n    cat.stdout.on('data', (line) => sort.stdin.write(line) );\n    cat.stdout.on('end', () => sort.stdin.end() );\n    sort.stdout.on('end', () => indexWriteStream.end() );\n    sort.stdout.on('end', () => print(COMMAND, 'Index file has been successfully updated.') )\n};\n\nlet backup = spawn('cp', [INDEX_FILE, INDEX_FILE + '.backup']);\n\nbackup.stdout.on('end', () => {\n    let inStream = byline(read(INDEX_FILE, {encoding: 'utf8'}));\n\n    let tmpExistingFileWriteStream = write(TMP_EXISTING_FILE, {encoding: 'utf8'});\n    let tmpProcessedFileWriteStream = write(TMP_PROCESSED_FILE, {encoding: 'utf8'});\n\n    // can be done with promises too.\n    let remainingMetaDataRequests = 0;\n    let inStreamEnded = false;\n\n    let maybeEndStreamsThenCopyAssets = null;\n\n    maybeEndStreamsThenCopyAssets = () => {\n        if (inStreamEnded && remainingMetaDataRequests === 0) {\n            let maybeCopyAssets = null;\n            let counter = 2;\n\n            maybeCopyAssets = () => {\n                counter--;\n\n                if (counter === 0) {\n                    copyAssets();\n                }\n\n                maybeCopyAssets = () => {};\n            };\n\n            // TODO: this part \"begs\" for promises.\n            tmpProcessedFileWriteStream.on('finish', maybeCopyAssets);\n            tmpExistingFileWriteStream.on('finish', maybeCopyAssets);\n\n            tmpProcessedFileWriteStream.end();\n            tmpExistingFileWriteStream.end();\n\n            maybeEndStreamsThenCopyAssets = () => {};\n        }\n    };\n\n    inStream.on('data', (line) => {\n\n        // TODO: to a util library function.\n        let occurrences = line.split('<::sif::>').length - 1;\n        let needsProcessing = occurrences === 0;\n        let alreadyProcessed = occurrences === 1;\n        let malformed = !needsProcessing && !alreadyProcessed;\n\n        if (malformed) {\n            error(COMMAND, `badly-formatted line: \"${line.replace(/sif/g, '__sif__')}\"`);\n\n            return;\n        }\n\n        if (needsProcessing) {\n            remainingMetaDataRequests++;\n\n            let url = line.trim();\n\n            request(url, (error, response, body) => {\n                remainingMetaDataRequests--;\n\n                if (error || response.statusCode !== SUCCESS) {\n                    maybeEndStreamsThenCopyAssets();\n\n                    return;\n                }\n\n                let replaced = body.replace(/\\s+/g, ' ');\n                let result = /<title>(.*?)<\\/title>/i.exec(replaced);\n                let title = result[1];\n\n                if (title) {\n                    tmpProcessedFileWriteStream.write(url + ' <::sif::> ' + title + '\\n');\n                } else {\n                    error(COMMAND, `no title found for: \"${url}\"; I'll leave it untouched. — Please file a bug at xxx to get it fixed.`);\n\n                    tmpExistingFileWriteStream.write(url + '\\n');\n                }\n\n                maybeEndStreamsThenCopyAssets();\n            });\n\n            return;\n        }\n\n        tmpExistingFileWriteStream.write(line.trim() + '\\n');\n    });\n\n    inStream.on('end', () => {\n        inStreamEnded = true;\n\n        // on `end`, all the data is consumed.\n        maybeEndStreamsThenCopyAssets();\n    });\n});\n"]}